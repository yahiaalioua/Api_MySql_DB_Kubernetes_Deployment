name: product-api-docker-build-push

on:
  push:
    branches:
      - 'main'
    paths-ignore:
      - '**/*.yaml'
      - '**/*.yml'
      - '**/*.txt'
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
    
env:
    KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
jobs:
  build_and_push_docker_image:
    runs-on: "self-hosted"
    steps:
    
      - name: Debug
        run: |
          echo "github.ref -> {{ github.ref }}"
 
      - name: Docker metadata
        id: metadata
        uses: docker/metadata-action@v3
        with:
          images: yahiaalioua/product-api
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value={{sha}},enable=${{ github.ref_type != 'tag' }}
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      -
        name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: Build and push
        uses: docker/build-push-action@v4
        with:
          push: true
          tags: ${{ steps.metadata.outputs.tags }}
          labels: ${{ steps.metadata.outputs.labels }}
          
      - name: Capture Generated Tag
        id: capture_tag
        run: |
          GENERATED_TAG=$(echo ${{ steps.metadata.outputs.tags }} | cut -d',' -f1)
          echo "Generated Docker image tag: $GENERATED_TAG"
          echo "GENERATED_TAG=$GENERATED_TAG" >> $GITHUB_ENV

      - name: Store Docker Image Tag for later update of k8s yaml file
        run: |
          GENERATED_TAG=$(echo ${{ needs.build_and_push_docker_image.outputs.GENERATED_TAG }})
  
  deploy_to_kubernetes:
    needs: build_and_push_docker_image
    runs-on: "self-hosted"

    steps:
      - name: Checkout code
        uses: actions/checkout@v2 

      - name: Update Kubernetes Deployment Image
        run: |
          GENERATED_TAG=${{ needs.build_and_push_docker_image.outputs.GENERATED_TAG }}
          sed -i "s|image: yahiaalioua/product-api:.*|image: yahiaalioua/product-api:$GENERATED_TAG|g" k8s_Deployment/product-api-deployment.yaml

      - name: Deploy api(Deployment)
        uses: actions-hub/kubectl@master
        with:
          args: apply -f k8s_Deployment/product-api-deployment.yaml
      
      - name: Deploy load balancer service(Deployment)
        uses: actions-hub/kubectl@master
        with:
          args: apply -f k8s_Deployment/product-api-loadbalancer.yaml
  
